name: Auto-Generate Fixture Analysis

on:
  # 1. Scheduled run: Check every day at 00:40 UTC
  schedule:
    - cron: '40 0 * * *'
  # 2. Manual run (for development/testing)
  workflow_dispatch:
  # 3. Runs on push (good for testing logic changes)
  push:
    branches: [ "main" ]
    paths:
      - 'src/**.py'
      - '*.py'
      - '.github/workflows/main_run.yml' # Reruns if workflow logic changes

jobs:
  run_analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for git-auto-commit-action

    # NOTE: max-attempts is omitted due to environment restrictions.
    # Retry logic is handled within the 'Generate New Documentation Content' step.
    strategy:
      fail-fast: false
      matrix: # Correctly indented sibling to 'fail-fast'
        os: [ ubuntu-latest ]
        python-version: [ '3.11' ]

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }} # Use matrix value

      - name: üì¶ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests pandas tabulate # Install minimal required libraries
          fi

      # -------------------------------------------------------------
      # ‚è∞ DATE CHECK LOGIC (Robust Timestamp Comparison)
      # Determines if the target run date has been reached.
      # -------------------------------------------------------------
      - name: ‚è≥ Check Next Run Condition
        id: check_time
        # Set RUN_ANALYSIS=true by default for the very first run
        env:
          RUN_ANALYSIS: true
        run: |
          # 1. Define the file path for the next fixture date (must be generated by main.py)
          FIXTURE_DATE_FILE="data/next_fixture_date.log"
          
          # 2. Check if the next fixture date file exists
          if [ -f "$FIXTURE_DATE_FILE" ]; then
              # Read the date of the NEXT upcoming fixture
              NEXT_FIXTURE_DATE=$(cat "$FIXTURE_DATE_FILE" | xargs)
          
              # Get today's date
              CURRENT_DATE=$(date +%Y-%m-%d)
          
              # Calculate the target run date: 24 hours AFTER the next fixture date
              TARGET_RUN_DATE=$(date -d "$NEXT_FIXTURE_DATE + 1 day" +%Y-%m-%d)
          
              echo "Next Fixture Date: $NEXT_FIXTURE_DATE"
              echo "Target Run Date (24h after fixture): $TARGET_RUN_DATE"
              echo "Current Date: $CURRENT_DATE"
          
              # Convert YYYY-MM-DD date strings to Unix Timestamps for reliable comparison
              CURRENT_TIMESTAMP=$(date -d "$CURRENT_DATE" +%s)
              TARGET_TIMESTAMP=$(date -d "$TARGET_RUN_DATE" +%s)
              
              echo "Current Timestamp: $CURRENT_TIMESTAMP"
              echo "Target Timestamp: $TARGET_TIMESTAMP"
              
              # Initialize the result variable
              SHOULD_RUN_ANALYSIS="false"
              
              # Use numerical comparison: If Current Time is Greater Than or Equal To Target Time
              if (( CURRENT_TIMESTAMP >= TARGET_TIMESTAMP )); then         
                  SHOULD_RUN_ANALYSIS="true"
              fi
              
              # Separate Action Logic
              if [[ "$SHOULD_RUN_ANALYSIS" == "true" ]]; then
                  echo "::notice:: Target date ($TARGET_RUN_DATE) reached. Proceeding with analysis."
                  echo "RUN_ANALYSIS=true" >> $GITHUB_ENV
              else
                  echo "::notice:: Fixtures are not complete or next fixture is far away. Skipping run."
                  echo "RUN_ANALYSIS=false" >> $GITHUB_ENV
              fi
          
          else
              # First run scenario: ensures the script runs to create the files
              echo "::warning:: Next fixture date file not found. Assuming first run. Proceeding with analysis."
              echo "RUN_ANALYSIS=true" >> $GITHUB_ENV
          fi

      # -------------------------------------------------------------
      # üìù GENERATE ANALYSIS (WITH STEP-LEVEL RETRY)
      # This entire block only runs if RUN_ANALYSIS is true
      # -------------------------------------------------------------
      - name: üìù Generate New Documentation Content (Max 5 Retries)
        if: env.RUN_ANALYSIS == 'true'
        id: run_generator
        shell: bash
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES to run main.py..."
              if python main.py; then
                  echo "Python script succeeded."
                  exit 0 # Success
              else
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                      # Calculate sleep duration: 30 seconds * attempt number
                      # Wait times: 30s, 60s, 90s, 120s
                      SLEEP_DURATION=$((RETRY_COUNT * 30))
                      echo "Python script failed. Retrying in ${SLEEP_DURATION} seconds..."
                      sleep $SLEEP_DURATION # Wait time increases with each failure
                  fi
              fi
          done
          
          echo "Python script failed after $MAX_RETRIES attempts."
          exit 1 # Fail the step, which will fail the job

      # -------------------------------------------------------------
      # üíæ LOG & COMMIT
      # Only runs after successful generation and logging of the new run time
      # -------------------------------------------------------------
      - name: ‚ûï Concatenate Docs into README.md
        if: success() && env.RUN_ANALYSIS == 'true'
        run: |
          # 1. Start with the TEMPLATE.md content
          cat data/TEMPLATE.md > README.md
          
          # 2. Add separator (optional)
          echo "" >> README.md
          echo "## üöÄ Live Prediction Analysis Summary" >> README.md
          echo "" >> README.md
          
          # 3. Append the dynamically generated content
          cat data/CLUBELO_COMPARISON.md >> README.md

      - name: ‚¨ÜÔ∏è Commit and Push Final Documentation
        if: success() && env.RUN_ANALYSIS == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: Auto-update analysis and log time."
          files: |
            README.md 
            data/** 